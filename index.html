<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TiffyAI Token Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background:#f3f4f6; color:#1f2937; }
    .glow { animation: glow 1.5s ease-in-out infinite; }
    @keyframes glow {
      0%,100% { box-shadow:0 0 5px #4ade80,0 0 10px #4ade80; }
      50% { box-shadow:0 0 20px #4ade80,0 0 40px #4ade80; }
    }
  </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">

  <div class="w-full max-w-2xl bg-white rounded-xl shadow-lg p-6 space-y-6">
    <h1 class="text-3xl font-bold text-center text-gray-800">Chat with Tokens</h1>

    <!-- User Info -->
    <div class="flex flex-col md:flex-row items-center justify-between p-3 bg-gray-50 rounded-lg">
      <div class="flex-1 flex items-center mb-2 md:mb-0">
        <span class="text-gray-600 font-medium mr-2">Online:</span>
        <span id="onlineCount" class="text-green-500 font-bold text-lg glow">0</span>
      </div>
      <div class="flex-1 flex items-center justify-end">
        <span class="text-gray-600 font-medium mr-2">You are:</span>
        <span id="userName" class="text-gray-800 font-semibold text-base">Loading...</span>
      </div>
    </div>

    <!-- Chat History -->
    <div id="chatHistory" class="bg-gray-50 p-4 rounded-lg h-96 overflow-y-auto border border-gray-200 space-y-4"></div>

    <!-- Input -->
    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
      <input type="text" id="messageInput" placeholder="Type your message..."
        class="flex-1 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
      <button id="sendMessageButton"
        class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700">
        Send
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    // ðŸ”‘ Replace with YOUR Firebase config (real values from console)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "tiffyai.firebaseapp.com",
      projectId: "tiffyai",
      storageBucket: "tiffyai.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let userId = null;
    let userName = "Anonymous";

    const chatHistory = document.getElementById("chatHistory");
    const input = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendMessageButton");
    const userNameEl = document.getElementById("userName");
    const onlineCountEl = document.getElementById("onlineCount");

    // Display message
    function displayMessage(text, sender, isSelf) {
      const div = document.createElement("div");
      div.className = `flex ${isSelf ? "justify-end" : "justify-start"}`;
      div.innerHTML = `
        <div class="p-3 rounded-xl max-w-xs ${isSelf ? "bg-blue-500 text-white" : "bg-gray-200 text-gray-800"}">
          <span class="font-bold block mb-1">${sender}</span>${text}
        </div>`;
      chatHistory.appendChild(div);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    // Send message
    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      await addDoc(collection(db, "messages"), {
        text,
        userId,
        userName,
        timestamp: serverTimestamp()
      });
      input.value = "";
    }

    sendBtn.addEventListener("click", sendMessage);
    input.addEventListener("keypress", e => { if (e.key === "Enter") sendMessage(); });

    // Presence tracking
    async function trackPresence(uid) {
      const ref = doc(db, "online_users", uid);
      setInterval(() => {
        setDoc(ref, { last_seen: serverTimestamp() }, { merge: true });
      }, 5000);
    }

    // Auth
    onAuthStateChanged(auth, async user => {
      if (user) {
        userId = user.uid;
        userNameEl.textContent = `User-${user.uid.slice(0, 5)}`;
        userName = userNameEl.textContent;

        // Track presence
        trackPresence(userId);

        // Listen messages
        const q = query(collection(db, "messages"), orderBy("timestamp"));
        onSnapshot(q, snap => {
          chatHistory.innerHTML = "";
          snap.forEach(doc => {
            const d = doc.data();
            displayMessage(d.text, d.userName || "Anonymous", d.userId === userId);
          });
        });

        // Listen online users
        onSnapshot(collection(db, "online_users"), snap => {
          const now = Date.now();
          const active = snap.docs.filter(d => {
            const data = d.data();
            return data.last_seen && now - data.last_seen.toMillis() < 10000;
          });
          onlineCountEl.textContent = active.length;
        });

      } else {
        signInAnonymously(auth).catch(err => console.error(err));
      }
    });
  </script>
</body>
</html>
